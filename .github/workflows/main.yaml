# CI: run MLflow project, collect artifacts of latest run, upload to GitHub Actions artifacts
on:
  workflow_dispatch:
  push: 
    branches: [ "main" ]

name: CI - MLflow -> Upload Artifact

jobs: 
  mlflow-and-artifact:  
    runs-on: ubuntu-latest
    steps:
      - name: Set up job
        run:  echo "Start CI job for WorkflowCI"

      - name:  Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12.7
        uses: actions/setup-python@v5
        with: 
          python-version: '3.12.7'

      - name: Check Env
        run: |
          echo "Python version:"
          python --version

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mlflow scikit-learn pandas matplotlib

      - name: Run mlflow project
        id: run_mlflow
        run: |
          cd MLProject
          # Set tracking URI lokal eksplisit
          export MLFLOW_TRACKING_URI=file://$(pwd)/mlruns
          echo "Using MLflow tracking URI: $MLFLOW_TRACKING_URI"
          mlflow run . --env-manager=local
        shell: bash
      
      - name: Get latest MLflow run_id
        id: get_run
        run: |
          # Gunakan tracking URI lokal yang sama
          export MLFLOW_TRACKING_URI=file://$(pwd)/MLProject/mlruns
          python - <<'PY'
          import os, sys
          from mlflow.tracking import MlflowClient
          
          tracking_uri = os.environ.get("MLFLOW_TRACKING_URI")
          print(f"Using tracking URI: {tracking_uri}", file=sys.stderr)
          client = MlflowClient(tracking_uri=tracking_uri)
          
          # Cari semua runs di semua experiments
          all_experiments = client.search_experiments()
          runs = []
          for experiment in all_experiments:
              exp_runs = client.search_runs(
                  [experiment.experiment_id], 
                  order_by=["attributes.start_time DESC"], 
                  max_results=1
              )
              if exp_runs:
                  runs.extend(exp_runs)
          
          if runs:
              runs.sort(key=lambda r: r.info.start_time, reverse=True)
              run_id = runs[0].info.run_id
              print(f"Found MLflow run_id: {run_id}")
              
              gh_out = os.environ.get("GITHUB_OUTPUT")
              if gh_out:
                  with open(gh_out, "a") as fh:
                      fh.write(f"mlflow_run_id={run_id}\n")
          else:
              print("No runs found", file=sys.stderr)
              sys.exit(2)
          PY
        shell: bash
  
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mlflow

      - name: Upload to Artifact
        run: |
          RUN_ID="${{ steps.get_run.outputs.mlflow_run_id }}"
          export MLFLOW_TRACKING_URI=file://$(pwd)/MLProject/mlruns
          echo "Downloading artifacts for run_id: $RUN_ID"
          OUT_DIR="out/run_${RUN_ID}"
          rm -rf "$OUT_DIR"
          mkdir -p "$OUT_DIR"
          
          python - <<PY
          import os
          from mlflow.tracking import MlflowClient
          
          run_id = os.environ.get("RUN_ID")
          out_dir = os.environ.get("OUT_DIR")
          tracking_uri = os.environ.get("MLFLOW_TRACKING_URI")
          
          client = MlflowClient(tracking_uri=tracking_uri)
          client.download_artifacts(run_id, "", dst_path=out_dir)
          print(f"Downloaded artifacts to {out_dir}")
          PY
          
          echo "Artifacts prepared for upload"
        env:
          RUN_ID: ${{ steps.get_run.outputs.mlflow_run_id }}
          OUT_DIR: out/run_${{ steps.get_run.outputs.mlflow_run_id }}
        shell: bash

      # âœ… UPLOAD KE GITHUB ACTIONS ARTIFACTS (Ganti Google Drive)
      - name: Upload Artifacts to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: mlflow-artifacts-${{ steps.get_run.outputs.mlflow_run_id }}
          path: out/run_${{ steps.get_run.outputs. mlflow_run_id }}
          retention-days: 30

      - name: Build Docker Model
        run: |
          echo "Building Docker image for MLflow model"
          RUN_ID="${{ steps.get_run.outputs.mlflow_run_id }}"
          cd MLProject
          docker build -t mlflow-model: $RUN_ID . 

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with: 
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets. DOCKER_PASSWORD }}

      - name: Tag Docker Image
        run:  |
          RUN_ID="${{ steps.get_run.outputs.mlflow_run_id }}"
          docker tag mlflow-model:$RUN_ID ${{ secrets.DOCKER_USERNAME }}/mlflow-model:$RUN_ID
          docker tag mlflow-model:$RUN_ID ${{ secrets.DOCKER_USERNAME }}/mlflow-model: latest

      - name: Push Docker Image
        run: |
          RUN_ID="${{ steps. get_run.outputs.mlflow_run_id }}"
          docker push ${{ secrets.DOCKER_USERNAME }}/mlflow-model:$RUN_ID
          docker push ${{ secrets.DOCKER_USERNAME }}/mlflow-model:latest

      - name: Post Log in to Docker Hub
        if: always()
        run: echo "Docker Hub logout or cleanup"

      - name: Post Set up Python 3.12.7
        if: always()
        run: echo "Python setup cleanup"

      - name: Post Checkout repository
        if: always()
        run: echo "Checkout cleanup"

      - name: Complete job
        run: echo "CI job finished successfully"
