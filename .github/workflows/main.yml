name: MLflow CI - Retrain & Publish

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

env:
  # Set an image name prefix; can be overriden via workflow inputs or secrets
  IMAGE_NAME: workflow-ci-model

jobs:
  train:
    name: Run MLflow Project (retrain)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.8"

      - name: Install runtime deps (for mlflow run --no-conda)
        run: |
          python -m pip install --upgrade pip
          pip install mlflow scikit-learn pandas numpy joblib

      - name: Run MLflow Project (no-conda)
        # We call the MLProject entry point. Use --no-conda in CI to avoid conda setup.
        run: |
          mlflow --version
          mlflow run MLProject -e main -P data_path="MLProject/namadataset_preprocessing/dataset.csv" -P output="artifacts/model" --no-conda

      - name: List artifacts folder
        run: |
          echo "Contents of artifacts/:"
          ls -la artifacts || true
          echo "Contents of artifacts/model:"
          ls -la artifacts/model || true

      - name: Upload model artifact (GitHub Actions artifact)
        uses: actions/upload-artifact@v4
        with:
          name: model-artifact
          path: artifacts/model

  build-and-push-docker:
    name: Build Docker image from MLflow model and push to Docker Hub (optional)
    runs-on: ubuntu-latest
    needs: train
    # Do NOT reference secrets or env in a job-level if expression (not available there).
    # The steps below will check secrets at step-level (which is allowed).
    env:
      # You *can* map job env vars from secrets; steps can also reference secrets directly.
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      # IMAGE_NAME is inherited from top-level env; no need to reassign via expression.

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        if: ${{ env.DOCKERHUB_USERNAME && env.DOCKERHUB_TOKEN }}
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        if: ${{ env.DOCKERHUB_USERNAME && env.DOCKERHUB_TOKEN }}
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Install mlflow
        if: ${{ env.DOCKERHUB_USERNAME && env.DOCKERHUB_TOKEN }}
        run: |
          python -m pip install --upgrade pip
          pip install mlflow

      - name: Build Docker image from saved MLflow model
        if: ${{ env.DOCKERHUB_USERNAME && env.DOCKERHUB_TOKEN }}
        run: |
          # mlflow models build-docker requires a model directory with MLmodel file.
          # We saved model in artifacts/model during training step.
          MODEL_DIR="artifacts/model"
          IMAGE_TAG="${DOCKERHUB_USERNAME}/${IMAGE_NAME}:latest"
          if [ ! -d "$MODEL_DIR" ]; then
            echo "$MODEL_DIR not found. Ensure training job wrote model to artifacts/model"
            exit 1
          fi
          mlflow models build-docker -m "$MODEL_DIR" -n "${IMAGE_TAG}"
          echo "Built image ${IMAGE_TAG}"

      - name: Push Docker image
        if: ${{ env.DOCKERHUB_USERNAME && env.DOCKERHUB_TOKEN }}
        run: |
          IMAGE_TAG="${DOCKERHUB_USERNAME}/${IMAGE_NAME}:latest"
          docker push "${IMAGE_TAG}"
