# CI: run MLflow project, collect artifacts of latest run, upload to GitHub Actions artifacts
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

name: CI - MLflow -> Upload Artifact

jobs:
  mlflow-and-artifact:
    runs-on: ubuntu-latest
    env:
      # optional: set these in Secrets if you use remote MLflow tracking server
      MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
      MLFLOW_EXPERIMENT: ${{ secrets.MLFLOW_EXPERIMENT }} # optional: id or name
    steps:
      - name: Set up job
        run: echo "Start CI job for WorkflowCI"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Miniconda and create environment from MLProject/conda.yaml
        uses: conda-incubator/setup-miniconda@v2
        with:
          auto-update-conda: true
          python-version: "3.12"
          environment-file: MLProject/conda.yaml
          activate-environment: workflowci-env
          use-mamba: true

      - name: Ensure MLflow CLI available in env
        run: |
          conda run -n workflowci-env python -m pip install --upgrade pip
          conda run -n workflowci-env python -m pip install mlflow
        shell: bash

      - name: Run MLflow project (MLProject directory)
        id: run_mlflow
        run: |
          # jika MLProject/MLproject ada, ini akan menjalankan default entry point
          conda run -n workflowci-env mlflow run MLProject
        shell: bash

      - name: Get latest MLflow run_id (inline, writes to GITHUB_OUTPUT)
        id: get_run
        run: |
          conda run -n workflowci-env python - <<'PY'
          import os, sys
          from mlflow.tracking import MlflowClient
          tracking_uri = os.environ.get("MLFLOW_TRACKING_URI")
          client = MlflowClient(tracking_uri=tracking_uri) if tracking_uri else MlflowClient()
          exp = os.environ.get("MLFLOW_EXPERIMENT", "0")
          try:
              runs = client.search_runs([exp], order_by=["attributes.start_time DESC"], max_results=1)
          except Exception as e:
              print("Error searching runs:", e, file=sys.stderr)
              sys.exit(1)
          if not runs:
              print("No runs found for experiment:", exp, file=sys.stderr)
              sys.exit(2)
          run_id = runs[0].info.run_id
          print("Found run_id:", run_id)
          gh_out = os.environ.get("GITHUB_OUTPUT")
          if gh_out:
              with open(gh_out, "a") as fh:
                  fh.write(f"mlflow_run_id={run_id}\n")
          else:
              # fallback (shouldn't be needed on Actions)
              print(f"mlflow_run_id={run_id}")
          PY
        shell: bash

      - name: Download artifacts for latest run into out/
        id: download_artifacts
        run: |
          set -e
          RUN_ID="${{ steps.get_run.outputs.mlflow_run_id }}"
          echo "Downloading artifacts for run_id: $RUN_ID"
          OUT_DIR="out/run_${RUN_ID}"
          # remove if exists
          rm -rf "$OUT_DIR"
          mkdir -p "$OUT_DIR"
          conda run -n workflowci-env python - <<PY
          import os, sys, shutil
          from mlflow.tracking import MlflowClient
          run_id = os.environ.get("RUN_ID")
          client = MlflowClient()
          # download all artifacts of the run (pass path "" to get root)
          client.download_artifacts(run_id, "", dst_path=os.environ.get("OUT_DIR"))
          print("Downloaded artifacts to", os.environ.get("OUT_DIR"))
          PY
        env:
          RUN_ID: ${{ steps.get_run.outputs.mlflow_run_id }}
          OUT_DIR: out/run_${{ steps.get_run.outputs.mlflow_run_id }}
        shell: bash

      - name: List downloaded artifacts (debug)
        run: |
          echo "Contents of out/:"
          ls -R out || true

      - name: Upload model/artifacts to GitHub Actions (upload-artifact)
        uses: actions/upload-artifact@v4
        with:
          name: mlflow-run-${{ steps.get_run.outputs.mlflow_run_id }}
          path: out/run_${{ steps.get_run.outputs.mlflow_run_id }}

      - name: Complete job
        run: echo "CI job finished successfully"
